<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Toko - SewaMates</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <nav class="navbar">
      <a href="index.html" class="logo">
        <img
          src="img/sewamates-logo.png"
          alt="SewaMates Logo"
          class="logo-img"
        />
        <span class="logo-text">
          <span class="logo-black">Sewa</span><span class="logo-blue">Mates</span>
        </span>
      </a>
      <div id="nav-menu" class="nav-links"></div>
    </nav>

    <div class="container">
      <div
        style="
          background: white;
          padding: 20px;
          border-radius: 20px;
          min-height: 80vh;
        "
      >
        <h1>Dashboard Penyedia</h1>

        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('orders')">
            Pesanan Masuk
          </button>
          <button class="tab-btn" onclick="switchTab('inventory')">
            Barang Saya
          </button>
        </div>

        <div id="orders" class="tab-content active">
          <div id="incomingOrderList">Loading data...</div>
        </div>

        <div id="inventory" class="tab-content">
          <div id="inventoryContainer"></div>
        </div>
      </div>
    </div>

    <div id="addModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeAddModal()">&times;</span>
        <h2 id="modalTitle">Tambah Barang Baru</h2>

        <input type="hidden" id="editId" />

        <input
          type="text"
          id="pName"
          placeholder="Nama Barang"
          class="search-input"
          style="border: 1px solid #ddd; margin-bottom: 10px"
        />
        <input
          type="text"
          id="pCategory"
          placeholder="Kategori"
          class="search-input"
          style="border: 1px solid #ddd; margin-bottom: 10px"
        />
        <input
          type="number"
          id="pPrice"
          placeholder="Harga per hari (Rp)"
          class="search-input"
          style="border: 1px solid #ddd; margin-bottom: 10px"
        />
        <input
          type="text"
          id="pImg"
          placeholder="Link URL Gambar"
          class="search-input"
          style="border: 1px solid #ddd; margin-bottom: 10px"
        />
        <textarea
          id="pDesc"
          placeholder="Deskripsi Singkat"
          class="search-input"
          style="
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 10px;
          "
        ></textarea>

        <button onclick="saveProduct()" class="btn-main" id="btnSave">
          Simpan
        </button>
      </div>
    </div>

    <div id="deleteModal" class="modal">
      <div class="modal-content" style="text-align: center; max-width: 350px">
        <div
          style="
            background: #ffebee;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
          "
        >
          <i
            class="fas fa-trash-alt"
            style="font-size: 24px; color: #e74c3c"
          ></i>
        </div>
        <h3 style="margin: 0; color: #333">Hapus Barang?</h3>
        <p style="color: #666; font-size: 14px; margin: 10px 0 20px">
          Tindakan ini tidak dapat dibatalkan.
        </p>

        <div style="display: flex; gap: 10px">
          <button
            onclick="closeDeleteModal()"
            class="btn-main"
            style="background: #ecf0f1; color: #333; margin-top: 0"
          >
            Batal
          </button>
          <button
            onclick="confirmDelete()"
            id="btnConfirmDelete"
            class="btn-main"
            style="background: #e74c3c; margin-top: 0"
          >
            Ya, Hapus
          </button>
        </div>
      </div>
    </div>

    <div id="statusModal" class="modal" style="display: none; align-items: center; justify-content: center;">
      <div class="modal-content" style="text-align: center; padding: 40px; border-radius: 20px; width: 300px;">
        <div id="statusIcon" style="font-size: 80px; margin-bottom: 20px; animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            âœ…
        </div>
        
        <h2 id="statusTitle" style="margin: 0; font-size: 24px;">Berhasil!</h2>
        <p id="statusDesc" style="color: #666; margin-top: 10px; font-size: 14px;">Status pesanan diperbarui.</p>
      </div>
    </div>

    <style>
        @keyframes popUp {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>

    <div id="confirmModal" class="modal" style="display: none; align-items: center; justify-content: center; z-index: 9999;">
      <div class="modal-content" style="text-align: center; max-width: 350px; padding: 30px; border-radius: 20px;">
        <div style="background: #e3f2fd; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
          <i class="fas fa-question" style="font-size: 24px; color: #4a69bd;"></i>
        </div>
        
        <h3 id="confirmTitle" style="margin: 0; color: #333;">Konfirmasi?</h3>
        <p id="confirmDesc" style="color: #666; font-size: 14px; margin: 10px 0 25px;">
            Apakah Anda yakin ingin memproses pesanan ini?
        </p>

        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="closeConfirmModal()" class="btn-main" style="background: #ecf0f1; color: #333; margin: 0; width: auto; padding: 10px 25px;">
            Batal
          </button>
          <button onclick="executeProcess()" id="btnConfirmAction" class="btn-main" style="background: #4a69bd; margin: 0; width: auto; padding: 10px 25px;">
            Ya, Lanjutkan
          </button>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>

    <script>
      let currentUser = null;
      let itemToDeleteId = null; 

      // Set session biar profil tau kita lagi mode provider
      sessionStorage.setItem("appMode", "provider");
      
      initData();
      const localUser = checkAuth();

      // Cek Status Login
      if (typeof firebase !== "undefined" && firebase.auth) {
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            currentUser = user;
            const ownerName = user.displayName || user.email;
            renderOrders(ownerName);
            renderInventory(ownerName);
          } else {
            if (localUser) {
              currentUser = { displayName: localUser.name, email: localUser.name };
              renderOrders(localUser.name);
              renderInventory(localUser.name);
            } else {
              window.location.href = "login.html";
            }
          }
        });
      }

      function switchTab(tabName) {
        document.querySelectorAll(".tab-content").forEach((el) => (el.style.display = "none"));
        document.querySelectorAll(".tab-btn").forEach((btn) => btn.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        event.target.classList.add("active");

        if (currentUser) {
          const ownerName = currentUser.displayName || currentUser.email;
          if (tabName === "orders") renderOrders(ownerName);
          if (tabName === "inventory") renderInventory(ownerName);
        }
      }

      // --- RENDER PESANAN ---
      async function renderOrders(ownerName) {
        const container = document.getElementById("incomingOrderList");
        container.innerHTML = '<p style="text-align:center; color:#888;">Memuat pesanan...</p>';

        try {
            const snapshot = await db.collection('orders').where('owner', '==', ownerName).get();
            
            if (snapshot.empty) {
                container.innerHTML = `<div style="text-align:center; padding: 40px; color:#999;"><p>Belum ada pesanan masuk.</p></div>`;
                return;
            }

            let orders = [];
            snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
            orders.sort((a, b) => b.createdAt - a.createdAt);

            let html = "";
            orders.forEach((o) => {
                const startObj = o.startDate ? o.startDate.toDate() : new Date();
                const endObj = o.endDate ? o.endDate.toDate() : new Date();
                const dateStr = `${startObj.getDate()}/${startObj.getMonth()+1} - ${endObj.getDate()}/${endObj.getMonth()+1}`;

                let actionBtns = "";
                if (o.status === "pending") {
                    actionBtns = `
                        <button onclick="processOrder('${o.id}', 'approved')" class="btn-main" style="width:auto; background:#2ecc71; padding:5px 15px; font-size:12px;">Terima</button>
                        <button onclick="processOrder('${o.id}', 'rejected')" class="btn-main" style="width:auto; background:#e74c3c; padding:5px 15px; font-size:12px;">Tolak</button>
                    `;
                } else {
                    let color = o.status === 'approved' ? '#2ecc71' : '#e74c3c';
                    actionBtns = `<span style="background:${color}; color:white; padding:4px 10px; border-radius:15px; font-size:12px; font-weight:bold;">${o.status.toUpperCase()}</span>`;
                }

                html += `
                    <div style="border:1px solid #eee; padding:15px; border-radius:10px; margin-bottom:10px; background:#fff;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <b style="font-size:16px;">${o.productName}</b><br>
                                <small>Penyewa: <b>${o.renterName || 'User'}</b></small><br>
                                <small>ðŸ“… ${dateStr} (${o.days} Hari)</small>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:bold; color:#4a69bd;">${formatRupiah(o.totalPrice || o.total)}</div>
                                <div style="margin-top:8px;">${actionBtns}</div>
                            </div>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        } catch (error) { container.innerHTML = "Gagal memuat pesanan."; }
      }

      // --- VARIABEL SEMENTARA BUAT NYIMPEN DATA PAS KLIK TOMBOL ---
      let tempOrderId = null;
      let tempNewStatus = null;

      // 1. FUNGSI DIPANGGIL PAS KLIK TOMBOL TERIMA/TOLAK
      // (Cuma buat buka modal nanya doang)
      function processOrder(orderId, newStatus) {
        tempOrderId = orderId;
        tempNewStatus = newStatus;

        const title = document.getElementById('confirmTitle');
        const desc = document.getElementById('confirmDesc');
        const btn = document.getElementById('btnConfirmAction');

        // Ubah teks modal sesuai aksi
        if (newStatus === 'approved') {
            title.innerText = "Terima Pesanan?";
            desc.innerText = "Pesanan akan masuk ke daftar aktif.";
            btn.innerText = "Ya, Terima";
            btn.style.background = "#2ecc71"; // Hijau
        } else {
            title.innerText = "Tolak Pesanan?";
            desc.innerText = "Pesanan akan dibatalkan permanen.";
            btn.innerText = "Ya, Tolak";
            btn.style.background = "#e74c3c"; // Merah
        }

        // Buka Modal Konfirmasi
        document.getElementById('confirmModal').style.display = 'flex';
      }

      function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
        tempOrderId = null;
        tempNewStatus = null;
      }

      // 2. FUNGSI EKSEKUSI (DIPANGGIL PAS KLIK "YA" DI MODAL)
      async function executeProcess() {
        if (!tempOrderId || !tempNewStatus) return;

        // 1. Simpan ID ke variabel lokal biar aman
        const currentId = tempOrderId;
        const currentStatus = tempNewStatus;

        // 2. Tutup tampilan modalnya saja (JANGAN panggil closeConfirmModal dulu)
        document.getElementById('confirmModal').style.display = 'none';

        try {
            // 3. Update ke Firebase pakai ID yang sudah diamankan
            await db.collection('orders').doc(currentId).update({
                status: currentStatus
            });

            // --- DISINI MULAI ANIMASI SUKSES ---
            const modal = document.getElementById('statusModal');
            const icon = document.getElementById('statusIcon');
            const title = document.getElementById('statusTitle');
            const desc = document.getElementById('statusDesc');

            // Reset Animasi
            icon.style.animation = 'none';
            icon.offsetHeight; 
            icon.style.animation = 'popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

            if(currentStatus === 'approved') {
                icon.innerHTML = 'âœ…';
                title.innerText = 'Pesanan Diterima!';
                title.style.color = '#2ecc71';
                desc.innerText = 'Penyewa akan segera diberitahu.';
            } else {
                icon.innerHTML = 'âŒ';
                title.innerText = 'Pesanan Ditolak';
                title.style.color = '#e74c3c';
                desc.innerText = 'Pesanan telah dibatalkan.';
            }

            modal.style.display = 'flex';

            // Tutup otomatis & Refresh data
            setTimeout(async () => {
                modal.style.display = 'none';
                // Reset variabel global di sini setelah semua selesai
                tempOrderId = null;
                tempNewStatus = null;
                
                if(currentUser) {
                    const ownerName = currentUser.displayName || currentUser.email;
                    await renderOrders(ownerName); 
                }
            }, 2000);

        } catch (error) {
            alert("Gagal: " + error.message);
            // Kalau gagal, jangan lupa reset juga
            tempOrderId = null;
            tempNewStatus = null;
        }
      }

      // --- [UPDATED] RENDER INVENTORY (ADA EDIT) ---
      async function renderInventory(ownerName) {
        const container = document.getElementById('inventoryContainer'); 
        container.innerHTML = '<p style="text-align:center; padding:20px;">Mengambil data barang...</p>';

        let allProducts = [];
        try {
            const snapshot = await db.collection('products').get();
            allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (e) { console.log(e); }
        
        const myProducts = allProducts.filter(p => p.owner === ownerName);
        
        if(myProducts.length === 0) {
            container.innerHTML = `<div style="text-align: center; padding: 40px; color: #888;">Belum ada barang.</div>`;
            return;
        }

        let html = `
            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                <button onclick="openAddModal()" class="btn-main" style="width: auto; padding: 10px 20px;"><i class="fas fa-plus"></i> Tambah Barang</button>
            </div>
            <div class="catalog-grid">
        `;

        myProducts.forEach(p => {
            // Encode data untuk dikirim ke fungsi Edit
            const productData = encodeURIComponent(JSON.stringify(p));

            html += `
                <div class="product-card">
                    <div class="product-img"><img src="${p.img}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/150'"></div>
                    <div class="product-info">
                        <div style="font-weight:bold;">${p.name}</div>
                        <div style="color:#4a69bd; font-size:14px;">${formatRupiah(p.price)}/hari</div>
                        
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <button onclick="openEditModal('${productData}')" style="flex:1; background:#f39c12; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer; font-size:12px;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="openDeleteModal('${p.id}')" style="flex:1; background:#ff6b6b; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer; font-size:12px;">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        html += `</div>`;
        container.innerHTML = html;
      }

      // --- [UPDATED] FUNGSI EDIT & TAMBAH ---
      function openAddModal() {
        document.getElementById("editId").value = ""; 
        document.getElementById("pName").value = "";
        document.getElementById("pCategory").value = "";
        document.getElementById("pPrice").value = "";
        document.getElementById("pImg").value = "";
        document.getElementById("pDesc").value = "";
        
        document.getElementById("modalTitle").innerText = "Tambah Barang Baru";
        document.getElementById("btnSave").innerText = "Simpan Barang";
        document.getElementById("addModal").style.display = "flex";
      }

      function openEditModal(encodedData) {
        const p = JSON.parse(decodeURIComponent(encodedData)); 

        document.getElementById("editId").value = p.id; 
        document.getElementById("pName").value = p.name;
        document.getElementById("pCategory").value = p.category;
        document.getElementById("pPrice").value = p.price;
        document.getElementById("pImg").value = p.img;
        document.getElementById("pDesc").value = p.desc;

        document.getElementById("modalTitle").innerText = "Edit Barang";
        document.getElementById("btnSave").innerText = "Update Perubahan";
        document.getElementById("addModal").style.display = "flex";
      }

      function closeAddModal() { document.getElementById("addModal").style.display = "none"; }
      
      async function saveProduct() {
        if(!currentUser) { alert("Sesi habis"); return; }

        const id = document.getElementById("editId").value;
        const name = document.getElementById('pName').value;
        const price = parseInt(document.getElementById('pPrice').value);
        const category = document.getElementById('pCategory').value;
        const desc = document.getElementById('pDesc').value;
        const imgUrl = document.getElementById('pImg').value; 

        if(name && price) {
            const btn = document.getElementById('btnSave');
            btn.innerText = "Menyimpan...";
            btn.disabled = true;

            const productData = {
                name: name, category: category, price: price,
                owner: currentUser.displayName || currentUser.email,
                img: imgUrl || 'https://via.placeholder.com/150', 
                desc: desc
            };

            try {
                // Variabel untuk teks pop-up
                let popupTitle = "";
                let popupDesc = "";

                if(id) {
                    // --- LOGIKA EDIT ---
                    await db.collection('products').doc(id).update(productData);
                    popupTitle = "Berhasil Diubah!";
                    popupDesc = "Data barang telah diperbarui.";
                } else {
                    // --- LOGIKA TAMBAH BARU ---
                    productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('products').add(productData);
                    popupTitle = "Barang Ditambahkan!";
                    popupDesc = "Barang baru siap disewakan.";
                }
                
                // 1. Tutup Form Modal Dulu
                closeAddModal();

                // 2. Tampilkan Pop-up Sukses (Centang)
                const modal = document.getElementById('statusModal');
                const icon = document.getElementById('statusIcon');
                const title = document.getElementById('statusTitle');
                const descText = document.getElementById('statusDesc');

                // Reset animasi biar gerak lagi
                icon.style.animation = 'none';
                icon.offsetHeight; 
                icon.style.animation = 'popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

                // Set Icon & Teks
                icon.innerHTML = 'âœ…';
                title.innerText = popupTitle;
                title.style.color = '#2ecc71'; // Warna Hijau
                descText.innerText = popupDesc;

                modal.style.display = 'flex';

                // 3. Refresh data di background & Tutup pop-up otomatis
                setTimeout(async () => {
                    modal.style.display = 'none';
                    await renderInventory(currentUser.displayName || currentUser.email);
                }, 2000); // Muncul selama 2 detik

            } catch (error) { 
                alert("Gagal: " + error.message); 
            } 
            finally { 
                btn.innerText = "Simpan"; 
                btn.disabled = false; 
            }

        } else { 
            alert("Nama & Harga wajib diisi!"); 
        }
      }

      // --- HAPUS BARANG ---
      function openDeleteModal(id) { itemToDeleteId = id; document.getElementById("deleteModal").style.display = "flex"; }
      function closeDeleteModal() { document.getElementById("deleteModal").style.display = "none"; itemToDeleteId = null; }

      async function confirmDelete() {
        if (!itemToDeleteId) return;
        
        const btn = document.getElementById('btnConfirmDelete');
        btn.innerText = "Menghapus...";
        
        try {
            // 1. Hapus dari Firestore
            await db.collection('products').doc(itemToDeleteId).delete();
            
            // 2. Tutup Modal Konfirmasi Hapus (yang ada tombol Ya/Tidak)
            closeDeleteModal();
            
            // 3. Tampilkan Pop-up Sukses Animasi
            const modal = document.getElementById('statusModal');
            const icon = document.getElementById('statusIcon');
            const title = document.getElementById('statusTitle');
            const desc = document.getElementById('statusDesc');

            // Reset Animasi
            icon.style.animation = 'none';
            icon.offsetHeight; 
            icon.style.animation = 'popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

            // Set Konten
            icon.innerHTML = 'âœ…'; 
            title.innerText = "Barang Dihapus";
            title.style.color = '#e74c3c'; // Warna Merah (Sesuai tema delete)
            desc.innerText = "Barang telah dihapus dari daftar.";

            modal.style.display = 'flex';

            // 4. Refresh Data & Tutup Otomatis
            setTimeout(async () => {
                modal.style.display = 'none';
                await renderInventory(currentUser.displayName || currentUser.email);
            }, 2000);

        } catch (error) { 
            alert("Gagal hapus: " + error.message); 
        } 
        finally { 
            btn.innerText = "Ya, Hapus"; 
        }
      }
      
      function formatRupiah(angka) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
      }

    </script>
  </body>
</html>