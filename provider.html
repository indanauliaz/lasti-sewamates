<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Toko - SewaMates</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <nav class="navbar">
      <a href="index.html" class="logo">
        <img
          src="img/sewamates-logo.png"
          alt="SewaMates Logo"
          class="logo-img"
        />
        <span class="logo-text">
          <span class="logo-black">Sewa</span><span class="logo-blue">Mates</span>
        </span>
      </a>
      <div id="nav-menu" class="nav-links"></div>
    </nav>

    <div class="container">
      <div
        style="
          background: white;
          padding: 20px;
          border-radius: 20px;
          min-height: 80vh;
        "
      >
        <h1>Dashboard Penyedia</h1>

        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('orders')">
            Pesanan Masuk
          </button>
          <button class="tab-btn" onclick="switchTab('inventory')">
            Barang Saya
          </button>
        </div>

        <div id="orders" class="tab-content active">
          <div id="incomingOrderList">Loading data...</div>
        </div>

        <div id="inventory" class="tab-content">
          <div id="inventoryContainer"></div>
        </div>
      </div>
    </div>

    <div id="addModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeAddModal()">&times;</span>
        <h2 id="modalTitle">Tambah Barang Baru</h2>

        <input type="hidden" id="editId" />

        <input
          type="text"
          id="pName"
          placeholder="Nama Barang"
          class="search-input"
          style="border: 1px solid #ddd; margin-bottom: 10px"
        />
        <input
          type="text"
          id="pCategory"
          placeholder="Kategori"
          class="search-input"
          style="border: 1px solid #ddd; margin-bottom: 10px"
        />
        <input
          type="number"
          id="pPrice"
          placeholder="Harga per hari (Rp)"
          class="search-input"
          style="border: 1px solid #ddd; margin-bottom: 10px"
        />
        <input
          type="text"
          id="pImg"
          placeholder="Link URL Gambar"
          class="search-input"
          style="border: 1px solid #ddd; margin-bottom: 10px"
        />
        <textarea
          id="pDesc"
          placeholder="Deskripsi Singkat"
          class="search-input"
          style="
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 10px;
          "
        ></textarea>

        <button onclick="saveProduct()" class="btn-main" id="btnSave">
          Simpan
        </button>
      </div>
    </div>

    <div id="deleteModal" class="modal">
      <div class="modal-content" style="text-align: center; max-width: 350px">
        <div
          style="
            background: #ffebee;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
          "
        >
          <i
            class="fas fa-trash-alt"
            style="font-size: 24px; color: #e74c3c"
          ></i>
        </div>
        <h3 style="margin: 0; color: #333">Hapus Barang?</h3>
        <p style="color: #666; font-size: 14px; margin: 10px 0 20px">
          Tindakan ini tidak dapat dibatalkan.
        </p>

        <div style="display: flex; gap: 10px">
          <button
            onclick="closeDeleteModal()"
            class="btn-main"
            style="background: #ecf0f1; color: #333; margin-top: 0"
          >
            Batal
          </button>
          <button
            onclick="confirmDelete()"
            id="btnConfirmDelete"
            class="btn-main"
            style="background: #e74c3c; margin-top: 0"
          >
            Ya, Hapus
          </button>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>

    <script>
      let currentUser = null;
      let itemToDeleteId = null; 

      // Inisialisasi Auth & Data
      initData();
      const localUser = checkAuth();

      // Cek Status Login
      if (typeof firebase !== "undefined" && firebase.auth) {
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            currentUser = user;
            const ownerName = user.displayName || user.email;
            // Panggil Render saat login berhasil
            renderOrders(ownerName);
            renderInventory(ownerName);
          } else {
            if (localUser) {
              currentUser = { displayName: localUser.name, email: localUser.name };
              renderOrders(localUser.name);
              renderInventory(localUser.name);
            } else {
              window.location.href = "login.html";
            }
          }
        });
      }

      // --- FUNGSI TAB ---
      function switchTab(tabName) {
        document.querySelectorAll(".tab-content").forEach((el) => (el.style.display = "none"));
        document.querySelectorAll(".tab-btn").forEach((btn) => btn.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        event.target.classList.add("active");

        if (currentUser) {
          const ownerName = currentUser.displayName || currentUser.email;
          if (tabName === "orders") renderOrders(ownerName);
          if (tabName === "inventory") renderInventory(ownerName);
        }
      }

      // --- [UPDATED] RENDER PESANAN MASUK (REALTIME DB) ---
      // --- RENDER PESANAN MASUK (VERSI ANTI ERROR) ---
      async function renderOrders(ownerName) {
        const container = document.getElementById("incomingOrderList");
        container.innerHTML = '<p style="text-align:center; color:#888;">Memuat pesanan...</p>';

        try {
            // VERSI AMAN: Kita hapus .orderBy dulu biar tidak butuh Index
            const snapshot = await db.collection('orders')
                                     .where('owner', '==', ownerName)
                                     // .orderBy('createdAt', 'desc') <--- INI BIANG KEROKNYA KITA UMPETIN DULU
                                     .get();
            
            if (snapshot.empty) {
                container.innerHTML = `
                    <div style="text-align:center; padding: 40px; color:#999;">
                        <i class="fas fa-clipboard-list" style="font-size:30px; margin-bottom:10px;"></i>
                        <p>Belum ada pesanan masuk.</p>
                    </div>`;
                return;
            }

            let html = "";
            
            // Kita urutkan manual pakai Javascript aja (Client side sorting)
            // Biar Firebase gak rewel minta index
            let orders = [];
            snapshot.forEach(doc => {
                orders.push({ id: doc.id, ...doc.data() });
            });

            // Urutkan dari yang terbaru (berdasarkan waktu dibuat)
            orders.sort((a, b) => {
                 let dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                 let dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                 return dateB - dateA; 
            });

            // Render HTML
            orders.forEach((o) => {
                const orderId = o.id;
                
                const startObj = o.startDate ? o.startDate.toDate() : new Date();
                const endObj = o.endDate ? o.endDate.toDate() : new Date();
                const dateStr = `${startObj.getDate()}/${startObj.getMonth()+1} - ${endObj.getDate()}/${endObj.getMonth()+1}/${endObj.getFullYear()}`;

                let actionBtns = "";
                if (o.status === "pending") {
                    actionBtns = `
                        <button onclick="processOrder('${orderId}', 'approved')" class="btn-main" style="width:auto; background:#2ecc71; padding:5px 15px; font-size:12px;">Terima</button>
                        <button onclick="processOrder('${orderId}', 'rejected')" class="btn-main" style="width:auto; background:#e74c3c; padding:5px 15px; font-size:12px;">Tolak</button>
                    `;
                } else {
                    let color = o.status === 'approved' ? '#2ecc71' : '#e74c3c';
                    actionBtns = `<span style="background:${color}; color:white; padding:4px 10px; border-radius:15px; font-size:12px; font-weight:bold;">${o.status.toUpperCase()}</span>`;
                }

                html += `
                    <div style="border:1px solid #eee; padding:15px; border-radius:10px; margin-bottom:10px; background:#fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <b style="font-size:16px; color:#333;">${o.productName}</b><br>
                                <small style="color:#555;">Penyewa: <b>${o.renterName || 'User'}</b></small><br>
                                <small style="color:#777;">
                                    ðŸ“… ${dateStr} <b style="color:#e67e22;">(${o.days} Hari)</b>
                                </small>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:bold; color:#4a69bd; font-size:16px;">${formatRupiah(o.totalPrice || o.total || 0)}</div>
                                <div style="margin-top:8px;">${actionBtns}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

        } catch (error) {
            console.error("Error ambil pesanan:", error);
            container.innerHTML = `<p style="color:red; text-align:center;">Gagal memuat: ${error.message}</p>`;
        }
      }

      // --- [UPDATED] PROSES TERIMA/TOLAK PESANAN ---
      async function processOrder(orderId, newStatus) {
        if(!confirm(`Yakin ingin mengubah status menjadi ${newStatus}?`)) return;
        
        try {
            // Update status di Firebase
            await db.collection('orders').doc(orderId).update({
                status: newStatus
            });
            
            // Refresh tampilan otomatis
            const ownerName = currentUser.displayName || currentUser.email;
            await renderOrders(ownerName);

        } catch (error) {
            alert("Gagal update status: " + error.message);
        }
      }

      // --- RENDER INVENTORY (SAMA SEPERTI SEBELUMNYA) ---
      async function renderInventory(ownerName) {
        const container = document.getElementById('inventoryContainer'); 
        container.innerHTML = '<p style="text-align:center; padding:20px;">Mengambil data barang...</p>';

        let allProducts = [];
        try {
            const snapshot = await db.collection('products').get();
            allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (e) {
            console.log("Error fetch products", e);
        }
        
        const myProducts = allProducts.filter(p => p.owner === ownerName);
        
        if(myProducts.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #888;">
                    <div style="background: #f0f2f5; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <i class="fas fa-box-open" style="font-size: 32px; color: #ccc;"></i>
                    </div>
                    <h3 style="margin: 0; color: #333;">Belum ada barang</h3>
                    <p style="margin: 10px 0 25px;">Mulai sewakan barangmu dan dapatkan penghasilan tambahan.</p>
                    <button onclick="openAddModal()" class="btn-main" style="width: auto; padding: 12px 30px; margin: 0 auto; display: inline-flex; align-items: center; gap: 8px;">
                        <i class="fas fa-plus"></i> Tambah Barang Pertama
                    </button>
                </div>
            `;
            return;
        }

        let html = `
            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                <div style="margin-right: auto; align-self: center; font-weight: bold; color: #555;">
                    Total: ${myProducts.length} Barang
                </div>
                <button onclick="openAddModal()" class="btn-main" style="width: auto; padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-plus"></i> Tambah Barang
                </button>
            </div>
            <div class="catalog-grid">
        `;

        myProducts.forEach(p => {
            html += `
                <div class="product-card" style="position:relative;">
                    <div class="product-img"><img src="${p.img}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/150'"></div>
                    <div class="product-info">
                        <div style="font-weight:bold;">${p.name}</div>
                        <div style="color:#4a69bd; font-size:14px;">${formatRupiah(p.price)}/hari</div>
                        
                        <button onclick="openDeleteModal('${p.id}')" style="margin-top:10px; background:#ff6b6b; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; width:100%; font-size:12px;">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                </div>
            `;
        });

        html += `</div>`;
        container.innerHTML = html;
      }

      // --- MODAL & DATA HELPER ---
      function openAddModal() {
        document.getElementById("editId").value = "";
        document.getElementById("pName").value = "";
        document.getElementById("pCategory").value = "";
        document.getElementById("pPrice").value = "";
        document.getElementById("pImg").value = "";
        document.getElementById("pDesc").value = "";
        document.getElementById("modalTitle").innerText = "Tambah Barang Baru";
        document.getElementById("btnSave").innerText = "Simpan Barang";
        document.getElementById("addModal").style.display = "flex";
      }

      function closeAddModal() { document.getElementById("addModal").style.display = "none"; }
      
      // Save Product
      async function saveProduct() {
        if(!currentUser) { alert("Sesi habis"); return; }

        const name = document.getElementById('pName').value;
        const price = parseInt(document.getElementById('pPrice').value);
        const category = document.getElementById('pCategory').value;
        const desc = document.getElementById('pDesc').value;
        const imgUrl = document.getElementById('pImg').value; 

        if(name && price) {
            const btn = document.getElementById('btnSave');
            btn.innerText = "Menyimpan...";
            btn.disabled = true;

            try {
                await db.collection('products').add({
                    name: name, category: category, price: price,
                    owner: currentUser.displayName || currentUser.email,
                    img: imgUrl || 'https://via.placeholder.com/150', 
                    desc: desc,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeAddModal();
                await renderInventory(currentUser.displayName || currentUser.email);
            } catch (error) { alert("Gagal: " + error.message); } 
            finally { btn.innerText = "Simpan Barang"; btn.disabled = false; }
        } else { alert("Nama & Harga wajib diisi!"); }
      }

      // Delete Product
      function openDeleteModal(id) { itemToDeleteId = id; document.getElementById("deleteModal").style.display = "flex"; }
      function closeDeleteModal() { document.getElementById("deleteModal").style.display = "none"; itemToDeleteId = null; }

      async function confirmDelete() {
        if (!itemToDeleteId) return;
        const btn = document.getElementById('btnConfirmDelete');
        const textAsli = btn.innerText;
        btn.innerText = "Menghapus...";
        btn.disabled = true;

        try {
            await db.collection('products').doc(itemToDeleteId).delete();
            closeDeleteModal();
            await renderInventory(currentUser.displayName || currentUser.email);
        } catch (error) { alert("Gagal hapus"); }
        finally { btn.innerText = textAsli; btn.disabled = false; }
      }

      function formatRupiah(angka) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
      }
    </script>
  </body>
</html>