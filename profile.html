<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profil Saya</title>
    <link rel="icon" href="img/sewamates-icon.png" type="image/png">
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <nav class="navbar">
      <a href="index.html" class="logo">
        <img
          src="img/sewamates-logo.png"
          alt="SewaMates Logo"
          class="logo-img"
        />
        <span class="logo-text">
          <span class="logo-black">Sewa</span><span class="logo-blue">Mates</span>
        </span>
      </a>
      <div id="nav-menu" class="nav-links"></div>
    </nav>

    <div class="container">
      <div
        style="
          background: white;
          padding: 30px;
          border-radius: 20px;
          margin-bottom: 30px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
          display: flex;
          align-items: center;
          gap: 20px;
          flex-wrap: wrap;
        "
      >
        <img
          id="profileImg"
          src=""
          style="
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #eee;
            background-color: #ddd;
          "
        />

        <div style="flex: 1; min-width: 200px;">
          <h2 id="profileName" style="margin: 0">Memuat...</h2>
          <p id="profileEmail" style="margin: 0; font-size: 14px; color: #888">
            ...
          </p>
          
          <div id="profileRoleBadge"
            style="
              margin-top: 10px;
              display: inline-block;
              padding: 5px 12px;
              background: #e2e3e5;
              border-radius: 20px;
              font-size: 12px;
              font-weight: 600;
              color: #41464b;
            "
          >
            Mode: Penyewa
          </div>
        </div>

        <button onclick="logout()" class="btn-main" style="background:#e74c3c; width:auto; padding:8px 15px; font-size:12px;">
            <i class="fas fa-sign-out-alt"></i> Keluar
        </button>
      </div>

      <div id="section-provider" style="display: none">
        <h3 style="margin-bottom: 15px; color: #4a69bd">ðŸ“Š Dashboard Keuangan Toko</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
          <div style="background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; padding: 20px; border-radius: 15px;">
            <p style="margin: 0; opacity: 0.8">Total Pendapatan</p>
            <h2 id="totalRevenue" style="margin: 5px 0; font-size: 28px">Rp 0</h2>
          </div>
          <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);">
            <p style="margin: 0; color: #888">Barang Disewakan</p>
            <h2 id="totalItems" style="margin: 5px 0; color: #333">0</h2>
          </div>
          <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);">
            <p style="margin: 0; color: #888">Transaksi Sukses</p>
            <h2 id="totalTransactions" style="margin: 5px 0; color: #2ecc71">0</h2>
          </div>
        </div>

        <div style="margin-top: 20px; text-align: center;">
          <a href="provider.html" class="btn-main" style="text-decoration: none; display: inline-block; width: auto; padding: 10px 30px;">
            Kelola Toko Saya
          </a>
        </div>
      </div>

      <div id="section-renter" style="display: block">
        <h3 style="margin-bottom: 15px; color: #4a69bd">ðŸ“¦ Riwayat Pesanan Saya</h3>
        <div id="myOrderList" style="margin-top: 15px">
          <p style="text-align:center; color:#888;">Memuat riwayat...</p>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>

    <script>
      initData();
      const localUser = checkAuth(); 
      let currentUser = null;
      
      // ðŸ”¥ INI LOGIKA OTOMATISNYA ðŸ”¥
      // Kita ambil catatan terakhir: user lagi jadi 'renter' atau 'provider'?
      // Kalau belum ada catatan, defaultnya 'renter'
      let currentAppMode = sessionStorage.getItem("appMode") || "renter";

      if (typeof firebase !== "undefined" && firebase.auth) {
          firebase.auth().onAuthStateChanged((user) => {
            if (user) {
              currentUser = user;
              renderProfilePage(user);
            } else if (localUser) {
                currentUser = { displayName: localUser.name, email: localUser.name };
                renderProfilePage(currentUser);
            } else {
              window.location.href = "login.html";
            }
          });
      }

      async function renderProfilePage(user) {
        const name = user.displayName || user.email;
        const email = user.email;

        // 1. ISI HEADER
        document.getElementById("profileName").innerText = name;
        document.getElementById("profileEmail").innerText = email;
        const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=4a69bd&color=fff&size=128`;
        document.getElementById("profileImg").src = photoURL;

        // 2. SET TAMPILAN SESUAI MODE TERAKHIR (OTOMATIS)
        const sectionProvider = document.getElementById("section-provider");
        const sectionRenter = document.getElementById("section-renter");
        const badge = document.getElementById("profileRoleBadge");

        if(currentAppMode === "provider") {
            // Tampilan Provider
            sectionProvider.style.display = "block";
            sectionRenter.style.display = "none";
            badge.innerText = "Mode: Penyedia Toko";
            badge.style.background = "#d1edfc"; 
            badge.style.color = "#055160";
            
            // Load Data Toko
            loadProviderStats(name);
        } else {
            // Tampilan Renter
            sectionProvider.style.display = "none";
            sectionRenter.style.display = "block";
            badge.innerText = "Mode: Penyewa";
            badge.style.background = "#e2e3e5"; 
            badge.style.color = "#41464b";

            // Load Riwayat
            loadRenterHistory(name);
        }
      }

      // --- LOGIC LOAD RIWAYAT (RENTER) ---
      async function loadRenterHistory(myName) {
          const container = document.getElementById("myOrderList");
          try {
              const snapshot = await db.collection('orders').where('renterName', '==', myName).get();

              if (snapshot.empty) {
                  container.innerHTML = `<p style="text-align:center; color:#888;">Belum ada riwayat belanja.</p>`;
                  return;
              }

              let orders = [];
              snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
              orders.sort((a, b) => b.createdAt - a.createdAt);

              let html = "";
              orders.forEach(o => {
                  let badgeStyle = "background:#eee; color:#333;";
                  let statusText = o.status.toUpperCase();
                  if(o.status === 'pending') { badgeStyle = "background:#fff3cd; color:#856404;"; statusText = "MENUNGGU"; }
                  else if (o.status === 'approved') { badgeStyle = "background:#d1e7dd; color:#0f5132;"; statusText = "DISETUJUI"; }
                  else if (o.status === 'rejected') { badgeStyle = "background:#f8d7da; color:#842029;"; statusText = "DITOLAK"; }
                  
                  const dateStr = o.startDate ? o.startDate.toDate().toLocaleDateString('id-ID') : '-';
                  html += `
                    <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #eee;">
                        
                        <img src="${o.productImg}" style="width:60px; height:60px; object-fit:cover; border-radius:10px; background:#eee;" onerror="this.src='https://via.placeholder.com/60'">
                        
                        <div style="flex:1;">
                            <h4 style="margin:0; font-size:16px;">${o.productName}</h4>
                            <p style="margin:5px 0; font-size:13px; color:#666;">
                                ${dateStr} (${o.days} Hari) | <b style="color:#4a69bd;">${formatRupiah(o.totalPrice || o.total)}</b>
                            </p>
                        </div>

                        <span style="
                            padding: 8px 15px; 
                            border-radius: 20px; 
                            font-size: 12px; 
                            font-weight: bold; 
                            margin-right: 10px; 
                            ${badgeStyle}">
                            ${statusText}
                        </span>
                    </div>`;
              });
              container.innerHTML = html;
          } catch (error) { console.error(error); }
      }

      // --- LOGIC STATISTIK PROVIDER ---
      async function loadProviderStats(myName) {
          try {
              const prodSnapshot = await db.collection('products').where('owner', '==', myName).get();
              document.getElementById("totalItems").innerText = prodSnapshot.size + " Unit";

              const orderSnapshot = await db.collection('orders').where('owner', '==', myName).where('status', '==', 'approved').get();
              let totalRev = 0;
              orderSnapshot.forEach(doc => { totalRev += (doc.data().totalPrice || 0); });

              document.getElementById("totalTransactions").innerText = orderSnapshot.size + " Kali";
              document.getElementById("totalRevenue").innerText = formatRupiah(totalRev);
          } catch (e) { }
      }

      function formatRupiah(angka) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
      }

      function logout() {
          firebase.auth().signOut().then(() => {
              sessionStorage.clear();
              window.location.href = "login.html";
          });
      }
    </script>
  </body>
</html>