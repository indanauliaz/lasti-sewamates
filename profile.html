<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profil Saya</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <nav class="navbar">
      <a href="index.html" class="logo">
        <img
          src="img/sewamates-logo.png"
          alt="SewaMates Logo"
          class="logo-img"
        />
        <span class="logo-text">
          <span class="logo-black">Sewa</span
          ><span class="logo-blue">Mates</span>
        </span>
      </a>

      <div id="nav-menu" class="nav-links"></div>
    </nav>

    <div class="container">
      <div
        style="
          background: white;
          padding: 30px;
          border-radius: 20px;
          margin-bottom: 30px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
          display: flex;
          align-items: center;
          gap: 20px;
        "
      >
        <img
          id="profileImg"
          src=""
          style="
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #eee;
          "
        />

        <div>
          <h2 id="profileName" style="margin: 0">Memuat...</h2>
          <p id="profileEmail" style="margin: 0; font-size: 14px; color: #888">
            ...
          </p>
          <div
            id="profileRoleBadge"
            style="
              margin-top: 10px;
              display: inline-block;
              padding: 5px 12px;
              background: #eee;
              border-radius: 20px;
              font-size: 12px;
              font-weight: 600;
              color: #555;
            "
          >
            Mode: ...
          </div>
        </div>
      </div>

      <div id="section-provider" style="display: none">
        <h3 style="margin-bottom: 15px; color: #4a69bd">
          ðŸ“Š Dashboard Keuangan Toko
        </h3>
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
          "
        >
          <div
            style="
              background: linear-gradient(135deg, #6c5ce7, #a29bfe);
              color: white;
              padding: 20px;
              border-radius: 15px;
            "
          >
            <p style="margin: 0; opacity: 0.8">Total Pendapatan</p>
            <h2 id="totalRevenue" style="margin: 5px 0; font-size: 28px">
              Rp 0
            </h2>
          </div>
          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 15px;
              box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            "
          >
            <p style="margin: 0; color: #888">Barang Disewakan</p>
            <h2 id="totalItems" style="margin: 5px 0; color: #333">0</h2>
          </div>
          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 15px;
              box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            "
          >
            <p style="margin: 0; color: #888">Transaksi Sukses</p>
            <h2 id="totalTransactions" style="margin: 5px 0; color: #2ecc71">
              0
            </h2>
          </div>
        </div>

        <div style="margin-top: 20px; text-align: center">
          <a
            href="provider.html"
            class="btn-main"
            style="
              text-decoration: none;
              display: inline-block;
              width: auto;
              padding: 10px 30px;
            "
          >
            Kelola Toko Saya
          </a>
        </div>
      </div>

      <div id="section-renter" style="display: none">
        <h3 style="margin-bottom: 15px; color: #4a69bd">
          ðŸ“¦ Riwayat Pesanan Saya
        </h3>
        <div id="myOrderList" style="margin-top: 15px">
          <p>Memuat riwayat...</p>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>

    <script>
      // Init Data & Navbar
      initData();
      checkAuth(); // Render Navbar atas

      // Tunggu Firebase Siap
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          renderProfilePage(user);
        } else {
          window.location.href = "login.html";
        }
      });

      function renderProfilePage(user) {
        // 1. ISI HEADER PROFIL
        const displayName = user.displayName || user.email.split("@")[0];
        const photoURL =
          user.photoURL ||
          `https://ui-avatars.com/api/?name=${encodeURIComponent(
            displayName
          )}&background=0D8ABC&color=fff`;

        document.getElementById("profileName").innerText = displayName;
        document.getElementById("profileEmail").innerText = user.email;
        document.getElementById("profileImg").src = photoURL;
        document.getElementById("profileImg").onerror = function () {
          this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(
            displayName
          )}&background=0D8ABC&color=fff`;
        };

        // 2. CEK MODE APLIKASI
        const currentMode = sessionStorage.getItem("appMode") || "renter";
        const roleBadge = document.getElementById("profileRoleBadge");

        if (currentMode === "provider") {
          // --- MODE PENYEDIA ---
          roleBadge.innerText = "Mode: Penyedia Barang";
          roleBadge.style.background = "#d1edfc";
          roleBadge.style.color = "#055160";

          document.getElementById("section-provider").style.display = "block";
          document.getElementById("section-renter").style.display = "none";

          // Hitung Statistik
          // Nama user harus konsisten dengan yang disimpan saat upload barang/order
          const ownerName = displayName || user.email;

          const allProducts = getProducts();
          const myProducts = allProducts.filter((p) => p.owner === ownerName);

          const incomingOrders = getIncomingOrders(ownerName);
          const successOrders = incomingOrders.filter(
            (o) => o.status === "approved" || o.status === "done"
          );

          // Hitung Duit
          const revenue = successOrders.reduce(
            (sum, order) => sum + parseInt(order.total),
            0
          );

          document.getElementById("totalRevenue").innerText =
            formatRupiah(revenue);
          document.getElementById("totalItems").innerText =
            myProducts.length + " Unit";
          document.getElementById("totalTransactions").innerText =
            successOrders.length + " Kali";
        } else {
          // --- MODE PENYEWA ---
          roleBadge.innerText = "Mode: Penyewa";
          roleBadge.style.background = "#e2e3e5";
          roleBadge.style.color = "#41464b";

          document.getElementById("section-provider").style.display = "none";
          document.getElementById("section-renter").style.display = "block";

          // Render List Belanja
          const renterName = displayName || user.email;
          const myOrders = getOrdersByRenter(renterName);
          const container = document.getElementById("myOrderList");
          container.innerHTML = "";

          if (myOrders.length === 0) {
            container.innerHTML =
              '<div style="text-align:center; padding:30px; background:white; border-radius:10px; color:#888; border: 1px dashed #ccc;">Belum ada riwayat belanja.</div>';
          } else {
            myOrders.forEach((o) => {
              let badgeClass = "bg-pending";
              let statusText = "Menunggu";
              if (o.status === "approved") {
                badgeClass = "bg-approved";
                statusText = "Disetujui";
              }
              if (o.status === "rejected") {
                badgeClass = "bg-rejected";
                statusText = "Ditolak";
              }
              if (o.status === "done") {
                badgeClass = "bg-paid";
                statusText = "Selesai";
              }

              container.innerHTML += `
                            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #eee;">
                                <img src="${
                                  o.productImg
                                }" style="width:60px; height:60px; object-fit:cover; border-radius:10px; background:#eee;">
                                <div style="flex:1;">
                                    <h4 style="margin:0; font-size:16px;">${
                                      o.productName
                                    }</h4>
                                    <p style="margin:5px 0; font-size:13px; color:#666;">
                                        Total: <b style="color:#4a69bd;">${formatRupiah(
                                          o.total
                                        )}</b> (${o.days} Hari)
                                    </p>
                                    <small style="color:#888;">Order ID: ${
                                      o.id
                                    }</small>
                                </div>
                                <span class="badge ${badgeClass}">${statusText}</span>
                            </div>
                        `;
            });
          }
        }
      }
    </script>
  </body>
</html>
