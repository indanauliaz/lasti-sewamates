<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Sewa & Checkout</title>
    <link rel="icon" href="img/sewamates-icon.png" type="image/png">
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <nav class="navbar">
      <a href="index.html" class="logo">
        <img
          src="img/sewamates-logo.png"
          alt="SewaMates Logo"
          class="logo-img"
        />
        <span class="logo-text">
          <span class="logo-black">Sewa</span><span class="logo-blue">Mates</span>
        </span>
      </a>
      <div id="nav-menu" class="nav-links"></div>
    </nav>

    <div class="container">
      <a
        href="index.html"
        style="
          display: inline-block;
          margin-bottom: 20px;
          text-decoration: none;
          color: #555;
        "
      >
        <i class="fas fa-arrow-left"></i> Kembali ke Katalog
      </a>

      <div
        style="
          background: white;
          border-radius: 15px;
          padding: 30px;
          display: flex;
          gap: 30px;
          flex-wrap: wrap;
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        "
      >
        <div style="flex: 1; min-width: 300px">
          <img
            id="itemImg"
            src=""
            alt="Gambar"
            onerror="this.src='https://via.placeholder.com/300'"
            style="
              width: 100%;
              height: 300px;
              object-fit: cover;
              border-radius: 15px;
              background: #eee;
            "
          />
        </div>

        <div style="flex: 1; min-width: 300px">
          <h1 id="itemName" style="margin-top: 0">Memuat Barang...</h1>
          <p style="color: #666">
            Penyedia: <b id="itemOwner" style="color: #333">...</b>
          </p>
          <div
            style="
              background: #f8f9fa;
              padding: 15px;
              border-radius: 10px;
              margin: 15px 0;
            "
          >
            <p id="itemDesc" style="margin: 0; font-size: 14px; color: #555">
              ...
            </p>
          </div>
          
          <div style="font-weight:bold; color:#4a69bd; margin-bottom:20px; font-size:18px;">
             Harga: <span id="itemPriceDisplay">Rp 0</span> / hari
          </div>

          <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0" />

          <h3 style="margin-bottom: 15px">Atur Jadwal Sewa</h3>
          
          <div
            style="
              display: grid; 
              grid-template-columns: 1fr 1fr; /* Membagi 2 kolom sama rata */
              gap: 15px;
              margin-bottom: 15px;
            "
          >
            <div>
              <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px;">Mulai</label>
              <input type="date" id="startDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;" />
            </div>
            <div>
              <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px;">Selesai</label>
              <input type="date" id="endDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;" />
            </div>
          </div>
          <div style="margin-bottom: 20px">
            <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px;">Metode Pengambilan</label>
            <select id="pickupMethod" onchange="calc()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; box-sizing: border-box;">
              <option value="meetup">ü§ù Ambil Langsung (Gratis)</option>
              <option value="locker">üîê Smart Locker ITB (+Rp 5.000)</option>
            </select>
          </div>

          <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; font-size: 14px; color: #666; margin-bottom: 5px;">
              <span>Biaya Sewa (<span id="dayCount">0</span> Hari)</span>
              <span id="rentCost">Rp 0</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 14px; color: #666; margin-bottom: 5px;">
              <span>Biaya Layanan</span>
              <span>Rp 2.000</span>
            </div>
            <div id="lockerRow" style="display: none; justify-content: space-between; font-size: 14px; color: #27ae60; margin-bottom: 5px;">
              <span>Biaya Smart Locker</span>
              <span>+ Rp 5.000</span>
            </div>

            <hr style="border: 0; border-top: 1px dashed #ccc; margin: 10px 0" />

            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: bold; color: #333">Total Pembayaran</span>
              <h2 id="totalPrice" data-total="0" data-days="0" style="color: var(--primary-color); margin: 0">Rp 0</h2>
            </div>
          </div>

          <button
            id="btnSewa"
            onclick="submitOrder()"
            class="btn-main"
            disabled
            style="opacity: 0.6; cursor: not-allowed; width: 100%;"
          >
            Pilih Tanggal Dulu
          </button>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>

    <script>
      let currentProduct = null;
      let currentUser = null;
      const ADMIN_FEE = 2000;
      const LOCKER_FEE = 5000;

      // 1. Inisialisasi
      initData();
      checkAuth();

      // 2. Cek Login & Load Data
      if (typeof firebase !== "undefined" && firebase.auth) {
        firebase.auth().onAuthStateChanged((user) => {
          if (user) {
            currentUser = user;
            loadProductData(); // Load data setelah user terdeteksi
          } else {
            // Jika belum login, simpan ID barang dan lempar ke login
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get("id");
            if (itemId) sessionStorage.setItem("pendingOrderId", itemId);
            window.location.href = "login.html";
          }
        });
      }

      // 3. Fungsi Ambil Data dari Firestore
      async function loadProductData() {
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get("id"); // Ambil ID dari URL (order.html?id=XYZ)

        if (!itemId) {
            alert("ID Barang tidak ditemukan!");
            window.location.href = "index.html";
            return;
        }

        try {
            // Ambil detail barang dari Firestore
            const doc = await db.collection('products').doc(itemId).get();
            
            if (!doc.exists) {
                document.querySelector(".container").innerHTML = "<h2 style='text-align:center'>Barang tidak ditemukan atau sudah dihapus.</h2>";
                return;
            }

            // Simpan data ke variabel global
            currentProduct = { id: doc.id, ...doc.data() };

            // Render ke HTML
            document.getElementById("itemName").innerText = currentProduct.name;
            document.getElementById("itemOwner").innerText = currentProduct.owner;
            document.getElementById("itemDesc").innerText = currentProduct.desc;
            document.getElementById("itemImg").src = currentProduct.img;
            document.getElementById("itemPriceDisplay").innerText = formatRupiah(currentProduct.price);

            // Validasi: Tidak boleh sewa barang sendiri
            const myName = currentUser.displayName || currentUser.email;
            if (currentProduct.owner === myName) {
                alert("‚ö†Ô∏è Anda tidak bisa menyewa barang milik sendiri!");
                window.location.href = "index.html";
            }

        } catch (error) {
            console.error("Error loading product:", error);
            alert("Gagal memuat barang.");
        }
      }

      // 4. Kalkulator Harga (Sama kayak sebelumnya, cuma dirapikan)
      function calc() {
        if (!currentProduct) return;

        const startVal = document.getElementById("startDate").value;
        const endVal = document.getElementById("endDate").value;
        const pickupMethod = document.getElementById("pickupMethod").value;

        const btn = document.getElementById("btnSewa");
        const lockerRow = document.getElementById("lockerRow");

        if (startVal && endVal) {
          const d1 = new Date(startVal);
          const d2 = new Date(endVal);

          // Hitung selisih hari
          const diffTime = d2 - d1;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

          if (diffDays > 0) {
            // Hitung Biaya
            const baseRent = diffDays * currentProduct.price;
            let lockerCost = (pickupMethod === "locker") ? LOCKER_FEE : 0;
            const grandTotal = baseRent + ADMIN_FEE + lockerCost;

            // Update UI
            document.getElementById("dayCount").innerText = diffDays;
            document.getElementById("rentCost").innerText = formatRupiah(baseRent);
            document.getElementById("totalPrice").innerText = formatRupiah(grandTotal);
            
            // Tampilkan/Sembunyikan baris locker
            lockerRow.style.display = (pickupMethod === "locker") ? "flex" : "none";

            // Simpan data di atribut tombol biar gampang diambil pas submit
            btn.dataset.total = grandTotal;
            btn.dataset.days = diffDays;

            // Enable tombol
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
            btn.innerText = "Ajukan Penyewaan";
          } else {
            btn.disabled = true;
            btn.style.opacity = "0.6";
            btn.innerText = "Tanggal tidak valid";
          }
        }
      }

      // Pasang Event Listener
      document.getElementById("startDate").addEventListener("change", calc);
      document.getElementById("endDate").addEventListener("change", calc);

      // 5. Submit Order ke Firebase
      async function submitOrder() {
        if (!currentUser || !currentProduct) return;

        const btn = document.getElementById("btnSewa");
        btn.innerText = "Memproses...";
        btn.disabled = true;

        const startVal = document.getElementById("startDate").value;
        const endVal = document.getElementById("endDate").value;
        const days = parseInt(btn.dataset.days);
        const total = parseInt(btn.dataset.total);
        const pickupMethod = document.getElementById("pickupMethod").value;

        try {
            // KIRIM KE FIREBASE
            // Kita simpan ke variabel 'docRef' biar bisa ambil ID-nya
            const docRef = await db.collection('orders').add({
                productId: currentProduct.id,
                productName: currentProduct.name,
                productImg: currentProduct.img,
                owner: currentProduct.owner,
                renterName: currentUser.displayName || currentUser.email,
                
                status: 'pending',       // Status pesanan
                paymentStatus: 'unpaid', // Status pembayaran awal
                days: days,
                totalPrice: total,
                pickupMethod: pickupMethod,
                
                startDate: firebase.firestore.Timestamp.fromDate(new Date(startVal)),
                endDate: firebase.firestore.Timestamp.fromDate(new Date(endVal)),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // üî• PERUBAHAN DISINI:
            // Jangan ke index, tapi ke payment.html bawa Order ID
            window.location.href = `payment.html?orderId=${docRef.id}`;

        } catch (error) {
            console.error("Error submit:", error);
            alert("Gagal membuat pesanan: " + error.message);
            btn.innerText = "Ajukan Penyewaan";
            btn.disabled = false;
        }
      }

      function formatRupiah(angka) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
      }
    </script>
  </body>
</html>